<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('../partials/head', { title: 'Relatórios - E-DUCA' }) %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .card { border: 1px solid #000 !important; }
        }
        .print-only { display: none; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .border-left-primary { border-left: 4px solid #4e73df !important; }
        .border-left-success { border-left: 4px solid #1cc88a !important; }
        .border-left-info { border-left: 4px solid #36b9cc !important; }
        .border-left-warning { border-left: 4px solid #f6c23e !important; }
    </style>
</head>
<body>
    <div class="d-flex">
        <%- include('partials/admin-sidebar', { currentPage: 'relatorios' }) %>
        
        <div class="main-content p-4">
            <div class="container-fluid">
                <!-- Cabeçalho -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <div>
                        <h1 class="h3 mb-0">Relatórios do Sistema</h1>
                        <p class="text-muted mb-0">Dados atualizados em tempo real</p>
                    </div>
                    <div class="btn-group no-print">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-download me-1"></i>Exportar
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exportToPDF()">PDF</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportToCSV()">CSV</a></li>
                        </ul>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Atualizar
                        </button>
                    </div>
                </div>

                <div class="print-only text-center mb-4">
                    <h2>Relatório do Sistema E-DUCA</h2>
                    <p class="text-muted">Gerado em: <span id="dataGeracao"><%= new Date().toLocaleString('pt-BR') %></span></p>
                    <hr>
                </div>

                <!-- Filtros -->
                <div class="row mb-4 no-print">
                    <div class="col-md-6">
                        <label for="periodo" class="form-label">Período</label>
                        <select class="form-select" id="periodo" onchange="filtrarRelatorios()">
                            <option value="7" <%= filtros.periodo === '7' ? 'selected' : '' %>>Últimos 7 dias</option>
                            <option value="30" <%= filtros.periodo === '30' ? 'selected' : '' %>>Últimos 30 dias</option>
                            <option value="90" <%= filtros.periodo === '90' ? 'selected' : '' %>>Últimos 3 meses</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="tipo" class="form-label">Tipo de Relatório</label>
                        <select class="form-select" id="tipo" onchange="filtrarRelatorios()">
                            <option value="geral" <%= filtros.tipo === 'geral' ? 'selected' : '' %>>Geral</option>
                            <option value="usuarios" <%= filtros.tipo === 'usuarios' ? 'selected' : '' %>>Usuários</option>
                            <option value="recursos" <%= filtros.tipo === 'recursos' ? 'selected' : '' %>>Recursos</option>
                        </select>
                    </div>
                </div>

                <!-- Estatísticas Principais -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Total de Usuários
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <%= stats.total_usuarios || 0 %>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-people fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Recursos Ativos
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <%= stats.recursos_ativos || 0 %>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-book fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                            Taxa de Crescimento
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <%= stats.taxa_crescimento || 0 %>%
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-graph-up fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2 stat-card">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                            Novos Usuários
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                                            <%= stats.novos_usuarios_periodo || 0 %>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="bi bi-person-plus fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Usuários por Etapa Preferida</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoUsuariosEtapa" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Recursos por Tipo</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoRecursosTipo" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabelas -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">Recursos Mais Recentes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Etapa</th>
                                                <th>Data</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (tabelas && tabelas.recursosMaisAcessados && tabelas.recursosMaisAcessados.length > 0) { %>
                                                <% tabelas.recursosMaisAcessados.forEach(function(recurso) { %>
                                                    <tr>
                                                        <td><%= recurso.titulo %></td>
                                                        <td><%= recurso.etapa %></td>
                                                        <td><%= new Date(recurso.data_criacao).toLocaleDateString('pt-BR') %></td>
                                                    </tr>
                                                <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="3" class="text-center">Nenhum recurso encontrado</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">Logs Recentes</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" width="100%" cellspacing="0">
                                        <thead>
                                            <tr>
                                                <th>Ação</th>
                                                <th>Descrição</th>
                                                <th>Data</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% if (tabelas && tabelas.logsRecentes && tabelas.logsRecentes.length > 0) { %>
                                                <% tabelas.logsRecentes.forEach(function(log) { %>
                                                    <tr>
                                                        <td><%= log.acao %></td>
                                                        <td><%= log.descricao %></td>
                                                        <td><%= new Date(log.data_log).toLocaleString('pt-BR') %></td>
                                                    </tr>
                                                <% }); %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="3" class="text-center">Nenhum log encontrado</td>
                                                </tr>
                                            <% } %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4 no-print">
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i> Imprimir Relatório
                    </button>
                    <a href="/admin/dashboard" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Voltar ao Dashboard
                    </a>
                </div>

                <div class="print-only text-center mt-4">
                    <hr>
                    <p class="text-muted small">
                        Relatório gerado automaticamente pelo Sistema E-DUCA
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para os gráficos -->
    <script>
        // Dados dos gráficos passados do EJS
        const graficos = <%- JSON.stringify(graficos || {}) %>;
        const stats = <%- JSON.stringify(stats || {}) %>;

        // Inicializar gráficos quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            inicializarGraficos();
        });

        function inicializarGraficos() {
            // Gráfico de Usuários por Etapa
            const ctxUsuarios = document.getElementById('graficoUsuariosEtapa');
            if (ctxUsuarios && graficos.usuariosPorEtapa) {
                new Chart(ctxUsuarios, {
                    type: 'pie',
                    data: {
                        labels: graficos.usuariosPorEtapa.labels,
                        datasets: [{
                            data: graficos.usuariosPorEtapa.data,
                            backgroundColor: [
                                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Gráfico de Recursos por Tipo
            const ctxRecursos = document.getElementById('graficoRecursosTipo');
            if (ctxRecursos && graficos.recursosPorTipo) {
                new Chart(ctxRecursos, {
                    type: 'bar',
                    data: {
                        labels: graficos.recursosPorTipo.labels,
                        datasets: [{
                            label: 'Quantidade de Recursos',
                            data: graficos.recursosPorTipo.data,
                            backgroundColor: '#36A2EB',
                            borderColor: '#2e59d9',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function filtrarRelatorios() {
            const periodo = document.getElementById('periodo').value;
            const tipo = document.getElementById('tipo').value;
            window.location.href = `/admin/relatorios?periodo=${periodo}&tipo=${tipo}`;
        }

        function refreshData() {
            location.reload();
        }

        function exportToPDF() {
            alert('Funcionalidade de exportar PDF em desenvolvimento');
        }

        function exportToCSV() {
            alert('Funcionalidade de exportar CSV em desenvolvimento');
        }
    </script>

    <%- include('../partials/footer') %>
</body>
</html>